<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>Campus Map</title>
  <style>
    :root{
      /* === LIGHT THEME VARIABLES === */
      --bg: #ffffff; 
      --panel: #ffffff; 
      --text: #1a1a1a; 
      --muted: #666666;
      --border: #e0e0e0;
      --input-bg: #f5f5f7;
      
      --accent: #007aff; 
      --marker: #ffb700; 
      --danger: #ff3b30; 
      
      --shadow: 0 4px 20px rgba(0,0,0,0.1); 
      --radius: 12px;
    }
    
    *{box-sizing:border-box}
    
    body{
      margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text); 
      overflow:hidden;
    }
    .app{
      height:100vh;
      display:grid;
      grid-template-rows:auto 1fr;
      overflow:hidden;
      position: relative;
    }
    
    /* Topbar */
    .topbar{
      display:flex; gap:10px; align-items:center; justify-content: center;
      padding:12px; 
      position: sticky;
      top: 0;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border); 
      z-index:30;
      flex-wrap: wrap;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }
    .brand{font-weight:700; font-size:18px; letter-spacing:-0.5px; margin-right: 8px; color: #000;}
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .topbar {
        padding: 8px;
        gap: 8px;
      }
      .brand {
        font-size: 16px;
        width: 100%;
        text-align: center;
        margin-right: 0;
        margin-bottom: 4px;
      }
      .searchWrap {
        flex: 1 1 100%;
        min-width: 0;
      }
      .btn {
        padding: 8px 12px;
        font-size: 13px;
      }
    }
    
    @media (max-width: 480px) {
      .stage {
        padding: 20px;
      }
    }
    
    .btn{
      border: 1px solid var(--border); background: #fff; color: var(--text);
      padding: 10px 16px; border-radius: 8px; cursor:pointer; 
      font-size:14px; font-weight:600;
      display:inline-flex; align-items:center; gap:6px; white-space:nowrap;
      transition: background 0.1s;
    }
    .btn:hover{ background: #f9f9f9; border-color:#ccc; }

    .searchWrap{position:relative; flex:0 1 320px; min-width:200px;}
    .search{
      width:100%; padding:10px 12px 10px 38px; border-radius:10px;
      border: 1px solid var(--border); background: var(--input-bg);
      color: var(--text); outline:none; font-size:16px;
    }
    .searchIcon{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.5}
    
    .dropdown{
      position:absolute; top:46px; left:0; right:0; background: #fff;
      border: 1px solid var(--border); border-radius:12px; overflow:hidden;
      box-shadow: var(--shadow); display:none; max-height:50vh; overflow:auto; z-index:50; text-align: left;
    }
    .dropdown.show{display:block}
    .dropItem{ padding:12px 16px; border-bottom:1px solid #f0f0f0; cursor:pointer; }
    .dropItem:hover{ background: #f5f5f7; }

    /* Map Stage - with elegant padding */
    .stage{
      position: relative;
      overflow: hidden; 
      background: var(--bg);
      padding: 40px;
      touch-action: none; /* Prevent default touch behaviors in stage area */
    }
    
    /* Map container with subtle styling */
    .mapContainer{
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #ffffff; /* White background for transparent SVG */
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      cursor: grab;
      touch-action: none; /* All touch handling done in JS */
    }
    .mapContainer.panning { cursor: grabbing; }
    
    /* SVG container - crisp at any zoom level */
    #mapSvgContainer{
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      user-select: none;
      touch-action: none;
      pointer-events: none;
      overflow: hidden;
    }
    
    #mapSvg {
      width: 100%;
      height: 100%;
    }

    /* SVG Markers - positioned in SVG coordinate space */
    .marker-circle {
      cursor: pointer;
      transition: r 0.2s ease-out;
    }
    .marker-circle:hover {
      r: 10;
    }
    
    .marker-label {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      font-size: 13px;
      font-weight: 600;
      fill: #fff;
      pointer-events: none;
      user-select: none;
    }
    
    .marker-label-bg {
      fill: #1a1a1a;
      rx: 10;
      ry: 10;
    }
    
    .marker-pin {
      cursor: pointer;
    }
    
    /* Pulse animation for start marker */
    @keyframes pulseRed {
      0% { opacity: 0.6; }
      50% { opacity: 0; }
      100% { opacity: 0; }
    }
    
    .pulse-ring {
      animation: pulseRed 2s infinite;
    }

    /* Info Panel Popup */
    .infoPanel {
      position: fixed;
      right: 20px;
      top: 50%;
      transform: translateY(-50%) translateX(400px);
      width: 350px;
      max-height: 80vh;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      overflow: hidden;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 40;
    }
    .infoPanel.show {
      transform: translateY(-50%) translateX(0);
    }
    .infoPanelHeader {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      background: #f8f9fa;
    }
    .infoPanelTitle {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      margin: 0 0 4px 0;
    }
    .infoPanelGroup {
      font-size: 13px;
      color: var(--accent);
      font-weight: 600;
    }
    .infoPanelClose {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: background 0.2s;
    }
    .infoPanelClose:hover {
      background: rgba(0,0,0,0.05);
    }
    .infoPanelBody {
      padding: 20px;
      overflow-y: auto;
      max-height: calc(80vh - 80px);
    }
    .infoPanelImage {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 16px;
      background: #f0f0f0;
      display: none;
    }
    .infoPanelImage.hasImage {
      display: block;
    }
    .infoPanelDescription {
      font-size: 15px;
      line-height: 1.6;
      color: var(--text);
      white-space: pre-wrap;
    }
    .infoPanelEmpty {
      color: var(--muted);
      font-style: italic;
      text-align: center;
      padding: 20px;
    }

    /* Mobile responsive info panel */
    @media (max-width: 768px) {
      .infoPanel {
        right: 10px;
        left: 10px;
        width: auto;
        bottom: 20px;
        top: auto;
        transform: translateY(500px);
        max-height: 60vh;
      }
      .infoPanel.show {
        transform: translateY(0);
      }
    }

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.4);
      display:none; align-items:center; justify-content:center; z-index:100;
      padding: 20px; backdrop-filter: blur(2px);
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width: 100%; max-width: 800px; height: 85vh; max-height: 800px;
      border-radius: 16px; background: #fff; box-shadow: var(--shadow);
      display: flex; flex-direction: column; overflow:hidden;
    }
    .modalHead{ padding: 16px 20px; display:flex; align-items:center; border-bottom: 1px solid var(--border); background: #fff; }
    .modalBody{ flex: 1; overflow: hidden; position: relative; background: #fafafa; }
    .listBox{
      height: 100%; overflow-y: auto; padding: 20px; display: grid; gap: 12px;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); align-content: start;
    }
    .listItem{
      padding:16px; border: 1px solid #eee; border-radius:12px; background: #fff; cursor:pointer;
      display:flex; justify-content:space-between; align-items:center; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
      transition: all 0.2s;
    }
    .listItem:hover{ border-color: var(--accent); transform: translateY(-1px); }
    .tag{
      font-size:11px; font-weight: 600; padding:3px 8px; border-radius:6px;
      background: #eff6ff; color: var(--accent); margin-right:8px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">Waypoints</div>
      <div class="searchWrap">
        <span class="searchIcon">ðŸ”Ž</span>
        <input id="searchInput" class="search" placeholder="Find a place..." autocomplete="off" />
        <div id="dropdown" class="dropdown"></div>
      </div>
      <button class="btn" id="homeBtn">â›¶ Fit</button>
      <button class="btn" id="listBtn">Directory</button>
    </div>

    <div class="stage">
      <div class="mapContainer" id="mapContainer">
        <div id="mapSvgContainer">
          <svg id="mapSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1164.2306 819.62">
            <image id="mapImage" href="map.svg" width="1164.2306" height="819.62" />
            <g id="markerLayer"></g>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <div class="modalBackdrop" id="listModal">
    <div class="modal">
      <div class="modalHead">
        <b style="font-size:1.1rem; color:#000;">Directory</b>
        <button class="btn" id="closeList" style="margin-left:auto;padding:6px 12px">Close</button>
      </div>
      <div class="modalBody">
        <div id="listBox" class="listBox"></div>
      </div>
    </div>
  </div>

  <!-- Info Panel -->
  <div class="infoPanel" id="infoPanel">
    <div class="infoPanelHeader">
      <div>
        <h2 class="infoPanelTitle" id="infoPanelTitle">Location</h2>
        <div class="infoPanelGroup" id="infoPanelGroup"></div>
      </div>
      <button class="infoPanelClose" id="infoPanelClose">Ã—</button>
    </div>
    <div class="infoPanelBody">
      <img class="infoPanelImage" id="infoPanelImage" alt="Location image" />
      <div class="infoPanelDescription" id="infoPanelDescription"></div>
    </div>
  </div>

<script>
(() => {
  // ---------------------------------------------------------
  // CONFIGURATION
  // ---------------------------------------------------------
  const CONFIG = {
    showAllMarkers: false  // Set to true to show yellow dots for all locations
  };
  
  const APP_DATA = {
  "version": 2,
  "map": {
    "src": "map.svg",
    "naturalW": 1164.2306,
    "naturalH": 819.62
  },
  "waypoints": [
    {
      "id": "0abc647659e7c19be8a891d5",
      "name": "Block B",
      "group": "",
      "description": "Level 1\n- Art Studio and Art Gallery\n- Bookshop\n- Stamford Training Room\n\nLevel 2\n- LT 5\n- Tutorial Rooms B21 - B22\n\nLevel 3\n- LT 4\n- Tutorial Rooms B31 - B35\n\nLevel 4\n- Tutorial Rooms B41 - B48\n\nLevel 5\n- Tutorial Rooms B51 - B58",
      "image": "",
      "xRel": 0.4819755568087193,
      "yRel": 0.5346357452152497
    },
    {
      "id": "e220a8dc8aa2d819be8ba8abf",
      "name": "Block L / MPH",
      "group": "",
      "description": "Level 1\n- E W Barker Institute of Sports\n- Sports Psychology Lab\n- Sports Pysiotheraphy Lab\n- Sports Science Lab\n\nLevel 2\n- Multiâ€“Purpose Hall",
      "image": "",
      "xRel": 0.8044557471203363,
      "yRel": 0.3271619555695936
    },
    {
      "id": "30282b2bf0f8e819be94ea7e2",
      "name": "S Rajaratnam Block",
      "group": "",
      "description": "Level 1\n- Makers Space\n\nLevel 2\n- Classrooms\n- Combined Civics Rooms 1 - 2\n\nLevel 3 - 7\n- Classrooms \n- G74-G78",
      "image": "",
      "xRel": 0.39465734156009347,
      "yRel": 0.4856904067237748
    },
    {
      "id": "f9914eabb7a7419be955ad7a",
      "name": "Marshall Block",
      "group": "",
      "description": "Level 1-3\n- Classroom",
      "image": "",
      "xRel": 0.2484785570674677,
      "yRel": 0.38478610536727914
    },
    {
      "id": "b6fd9e0ff0512819be957919c",
      "name": "RI Boarding",
      "group": "",
      "description": "",
      "image": "",
      "xRel": 0.3856153845046211,
      "yRel": 0.5861942239743176
    },
    {
      "id": "59f0b40db1d12819be957c201",
      "name": "Hullet Memorial Library",
      "group": "",
      "description": "",
      "image": "",
      "xRel": 0.3107809277569316,
      "yRel": 0.5999265956975247
    },
    {
      "id": "35472fb494e44819be958063e",
      "name": "Shaw Foundation Ceremonial Hall",
      "group": "",
      "description": "Level 2",
      "image": "",
      "xRel": 0.3319064442550832,
      "yRel": 0.559238086888022
    },
    {
      "id": "cd32a9430a095819be9585e56",
      "name": "Sheares Block",
      "group": "",
      "description": "Level 1\n- Raffles Discovery Studios \n\nLevel 2\n- Photocopy Centre\n- Computer Lab \n\nLevel 3 - 4\n- Classroom",
      "image": "",
      "xRel": 0.332980623060074,
      "yRel": 0.5058344190755497
    },
    {
      "id": "93e226d72fb8519be958b406",
      "name": "Block A",
      "group": "",
      "description": "Level 1\n- Art Studio (Left side of Drop off Point) \n- Education Technology Department\n- Raffles Media Lab\n- Raffles Media Studio\n- Theatre Studies Room\n\nLevel 2\n- Multiâ€“Purpose Studio\n- Tutorial Rooms A21- A24\n\nLevel 3 \n- MEP Resource Library\n- MEP Room 2\n- MEP Teachersâ€™ Workroom\n- Music Room\n- LT 3\n- Tutorial Rooms A32 - A34\n\nLevel 4\n- Tutorial Rooms A41 - A48\nLevel 5\nTutorial Rooms A51 - A58\nLevel 6\nTutorial Rooms A61 - A68\nLevel 7\nTutorial Rooms A71 - A78",
      "image": "",
      "xRel": 0.4769205829288356,
      "yRel": 0.4834557392303232
    },
    {
      "id": "6c5aa7e64588519be959b2c3",
      "name": "Block H",
      "group": "",
      "description": "Level 1\n- MLEP Room\n- Innovation Centre\n- Raffles Meeting Centre\n\nLevel 1M\n- Raffles Guidance Centre\n- Higher Education Office\n- Mt Sinai Boardroom\n\nLevel 2\n- Heads of Department\n\nLevel 3\n- Staff Room\n\nLevel 4\n- Shaw Foundation Library",
      "image": "",
      "xRel": 0.7138995155390256,
      "yRel": 0.48388617064768014
    },
    {
      "id": "8a3cd393425b8819be95ac843",
      "name": "Block G",
      "group": "",
      "description": "Level 1\n- Estate Department\n- Indoor Rifle Range\n- Staff Carpark 6\n\nLevel 2\n- Year 5-6 Tennis Courts",
      "image": "",
      "xRel": 0.61077812219549,
      "yRel": 0.33021175750753434
    },
    {
      "id": "b47e37cbb575e819be95afbdb",
      "name": "Year 5-6 Basketball Court",
      "group": "",
      "description": "",
      "image": "",
      "xRel": 0.6842295006121136,
      "yRel": 0.3625913161290366
    },
    {
      "id": "e365ffba4e09d819be95b44f6",
      "name": "Block E",
      "group": "",
      "description": "Level 1\n- Central Locker 2\n- Student Council Room\n- 1M\n- OpenLab\n- Physics Preparation Room 1\n- Physics Laboratory 1 â€“ 3\n\nLevel 2\n- Physics Laboratory 4 â€“ 7\n- Physics Preparation Room 2\n\nLevel 3\n- Biology Laboratory 1 â€“ 4\n- Biology Preparation Room\n\nLevel 4\n- Chemistry Laboratory 1 â€“ 4\n- Chemistry Preparation Room 1\n\nLevel 5\n- Chemistry Laboratory 5 â€“ 7\n- Chemistry Preparation Room 2\n\nLevel 6\n- Chemical Instrumentation\n- Laboratory\n- ClusterLabs\n- Material Science Laboratory\n- Research Preparation Room",
      "image": "",
      "xRel": 0.6125872694471309,
      "yRel": 0.4109036734373099
    },
    {
      "id": "6011ecb6d63b319be95bab2d",
      "name": "Parade Square",
      "group": "",
      "description": "Level 2",
      "image": "",
      "xRel": 0.6520266795329043,
      "yRel": 0.4155293246689531
    },
    {
      "id": "f873de80fafa6819be95bed3e",
      "name": "Block J",
      "group": "",
      "description": "Level 1\n- Performing Arts Centre\n\nLevel 3\n- LT 6\n- Tutorial Rooms J31 - J38",
      "image": "",
      "xRel": 0.7254780579495279,
      "yRel": 0.3625913161290366
    },
    {
      "id": "1a402b0444aa7819be95c5e80",
      "name": "Block K",
      "group": "",
      "description": "Level 1\n- Indoor Sports Hall\n\nLevel 2\n- PE Department Staff Room\n\nLevel 3\n- Dance Studio",
      "image": "",
      "xRel": 0.800401570431483,
      "yRel": 0.44895631528856245
    },
    {
      "id": "9547bbd03242d19be95d4859",
      "name": "Block D",
      "group": "",
      "description": "Level 1\n- Photocopy Centre\n- Student Affairs Centre\n\nLevel 2\n- Mini Lecture Theatre\n- Stamford Meeting Room\n- Tutorial Rooms D21-D22\n\nLevel 3\n- Seminar Rooms 5-7\n- Staff Lounge\n\nLevel 4\n- IT Office\n- Computer Lab 1-5\n- Jamming Room",
      "image": "",
      "xRel": 0.6463344653615938,
      "yRel": 0.5051182542111147
    },
    {
      "id": "5920b8cb2173b819be95e2e99",
      "name": "Block C",
      "group": "",
      "description": "Level 1\n- Amphitheatre\n- LT 2\n\nLevel 3\n- LT 1\n\nLevel 4\n- Central Locker 1\n\nLevel 7\n- Tutorial Rooms C71-C73",
      "image": "",
      "xRel": 0.5694080480829881,
      "yRel": 0.5133208473124734
    },
    {
      "id": "9225ebb414295819be95e9b43",
      "name": "Student Affairs Centre (SAC)",
      "group": "",
      "description": "",
      "image": "",
      "type": "start",
      "xRel": 0.6108616938551052,
      "yRel": 0.4799245753997985
    },
    {
      "id": "a4ff564fab3f119be95f352e",
      "name": "P4 Drop Off Point",
      "group": "",
      "description": "",
      "image": "",
      "xRel": 0.4956178556450773,
      "yRel": 0.5476454656851085
    },
    {
      "id": "64d7a8a41a1c319be95fc6bc",
      "name": "Year 5-6 Stadium",
      "group": "",
      "description": "",
      "image": "",
      "xRel": 0.24070147440990852,
      "yRel": 0.24863155702606815
    },
    {
      "id": "296e03d28d3a6819be96098d1",
      "name": "Office of Alumni Relations and Archives / Museum",
      "group": "",
      "description": "",
      "image": "",
      "xRel": 0.2563983190066156,
      "yRel": 0.4383668480846578
    },
    {
      "id": "361d36f74976a819be960f6ee",
      "name": "Science Laboratories",
      "group": "",
      "description": "",
      "image": "",
      "xRel": 0.2038863458339732,
      "yRel": 0.39931146152016195
    },
    {
      "id": "32a35e5ba0c9919be96394ec",
      "name": "Science Hub",
      "group": "",
      "description": "Level 1\n- Analytical Chemistry Lab\n- Chemistry Labs 1 - 4\n- Chemistry Preparation Room\n- Instrument Room\n- Material Science Lab\n- Resource & Meeting Room\n- Research Laboratory\n\nLevel 2\n- Computer Research Data Room\n- Discovery Labs 1 - 2\n- Physics Labs 1 - 4\n- Physics Preparation Room\n- Raffles Academy Home Room\n- Resource Work Room\n\nLevel 3\n- Biology Labs 1 - 3\n- Biology Preparation Room\n- Computer Lab 2\n- Keyframe Studio\n- Laser Animation / Technology Lab\n- Microbiology Lab\n- Molecular Genetics Lab\n- Photonics Lab\n- Plant Tissue Culture Lab",
      "image": "",
      "xRel": 0.17138339598657157,
      "yRel": 0.44297504350832145
    },
    {
      "id": "bea261743817119be9658d6a",
      "name": "Yusof Ishak Block",
      "group": "",
      "description": "Level 1\n- English Room\n- Estate Operations Office\n- Geography Room\n- History Room\n- Humanities Hub\n- LT 2\n- LT 3\n- Office of Alumni Relations and Archives / Museum\n- Raffles Guidance Centre\n- Regional Studies Programme Room\n- Staff Lounge\n- Yusof Ishak Room 1 & 2\n- Yusof Ishak Seminar Rooms 1-3\n\nLevel 2\n- Music Ensemble Studio 1 & 2\n- Heads of Department\n- LT 1\n- Staff Rooms 1-3\n\nLevel 3\n- Archives Storeroom\n- Computer Labs 5 & 6\n- Mathematics Room\n- Robotics Lab",
      "image": "",
      "xRel": 0.23840498249361677,
      "yRel": 0.5041756379343484
    },
    {
      "id": "aa051a4c08c69819be965e0e2",
      "name": "Astroturf",
      "group": "",
      "description": "",
      "image": "",
      "xRel": 0.1809579083447209,
      "yRel": 0.5424707467272424
    },
    {
      "id": "8e2ef0ec1478519be9663b71",
      "name": "Raffles Square",
      "group": "",
      "description": "",
      "image": "",
      "xRel": 0.26025092309604825,
      "yRel": 0.5551466510586772
    },
    {
      "id": "a2bd9cfd6551719be988f160",
      "name": "Albert Hong Hall",
      "group": "",
      "description": "Level 2",
      "image": "",
      "xRel": 0.22724647918839064,
      "yRel": 0.7372195470296233
    },
    {
      "id": "9ed3416480762819be98bb603",
      "name": "ARTSpace",
      "group": "",
      "description": "Level 1 \n- ARTspace\n\nLevel 2 \n- Gymnasium\n- MPH",
      "image": "",
      "xRel": 0.34329043192268877,
      "yRel": 0.6514690355047497
    },
    {
      "id": "1eff9a4522b39819be98be92d",
      "name": "Hong Leong Swimming Complex",
      "group": "",
      "description": "",
      "image": "",
      "xRel": 0.39376564024347205,
      "yRel": 0.6676588148155009
    },
    {
      "id": "da3946b42bbb0819be98cc5ec",
      "name": "Auditorium",
      "group": "",
      "description": "Level 3",
      "image": "",
      "xRel": 0.241115039595939,
      "yRel": 0.6860807236373596
    },
    {
      "id": "42ddbb0c360b519be98d6240",
      "name": "Year 5-6 Canteen",
      "group": "",
      "description": "",
      "image": "",
      "xRel": 0.6606524329136323,
      "yRel": 0.45160241393196165
    },
    {
      "id": "8d52282b6d33e19be98d9e5d",
      "name": "Year 1-4 Canteen",
      "group": "",
      "description": "",
      "image": "",
      "xRel": 0.24312263742257806,
      "yRel": 0.6353946835992513
    },
    {
      "id": "7ec11d629dd3419be98e66ba",
      "name": "Hodge Lodge",
      "group": "",
      "description": "Level 1",
      "image": "",
      "xRel": 0.6902233863979714,
      "yRel": 0.4418475638559808
    },
    {
      "id": "beef789af8680819be98ee5bb",
      "name": "Year 1-4 Field",
      "group": "",
      "description": "",
      "image": "",
      "xRel": 0.1655238691257058,
      "yRel": 0.6799909267196501
    },
    {
      "id": "60440740d40519be98f26c4",
      "name": "Year 1-4 Basketball / Tennis Court",
      "group": "",
      "description": "",
      "image": "",
      "xRel": 0.27914066219289757,
      "yRel": 0.6945025790470325
    },
    {
      "id": "55530317f02719be9900844",
      "name": "Softball Diamond",
      "group": "",
      "description": "",
      "image": "",
      "xRel": 0.1765638696614688,
      "yRel": 0.6105108943643046
    },
    {
      "id": "df41ddd4ad863819be9990619",
      "name": "Adminstration Centre",
      "group": "",
      "description": "",
      "image": "",
      "xRel": 0.45569800499278323,
      "yRel": 0.4955823889111197
    }
  ]
}

  const el = (id) => document.getElementById(id);
  const mapContainer = el("mapContainer");
  const mapSvg = el("mapSvg");
  const markerLayer = el("markerLayer");
  const searchInput = el("searchInput");
  const dropdown = el("dropdown");
  const listModal = el("listModal");
  const listBox = el("listBox");
  const infoPanel = el("infoPanel");
  const infoPanelTitle = el("infoPanelTitle");
  const infoPanelGroup = el("infoPanelGroup");
  const infoPanelImage = el("infoPanelImage");
  const infoPanelDescription = el("infoPanelDescription");

  // SVG viewBox state - THIS is where the magic happens
  let viewBox = {
    x: 0,
    y: 0,
    width: APP_DATA.map.naturalW,
    height: APP_DATA.map.naturalH,
    originalW: APP_DATA.map.naturalW,
    originalH: APP_DATA.map.naturalH
  };

  let state = {
    selectedId: null,
    isPanning: false,
    panStart: {x: 0, y: 0, vbX: 0, vbY: 0},
    pointers: new Map(),
    lastPinchDist: null,
    lastPinchCenter: {x: 0, y: 0},
    minZoom: 1,
    maxZoom: 10
  };

  function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

  // Convert screen coordinates to SVG coordinates (handling "meet" aspect ratio)
  function screenToSvg(screenX, screenY) {
    const rect = mapContainer.getBoundingClientRect();
    
    // Calculate how the SVG is scaled/positioned within the container
    const scaleX = rect.width / viewBox.width;
    const scaleY = rect.height / viewBox.height;
    const scale = Math.min(scaleX, scaleY);
    
    // Calculate the actual rendered dimensions of the SVG content
    const renderW = viewBox.width * scale;
    const renderH = viewBox.height * scale;
    
    // Calculate offsets (centering)
    const offsetX = (rect.width - renderW) / 2;
    const offsetY = (rect.height - renderH) / 2;
    
    // Convert screen coordinates relative to container
    const containerX = screenX - rect.left;
    const containerY = screenY - rect.top;
    
    // Convert to SVG coordinates
    const svgX = viewBox.x + (containerX - offsetX) / scale;
    const svgY = viewBox.y + (containerY - offsetY) / scale;
    
    return {x: svgX, y: svgY};
  }
  
  // Create SVG element helper
  function createSVGElement(tag, attrs = {}) {
    const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
    Object.entries(attrs).forEach(([key, value]) => {
      el.setAttribute(key, value);
    });
    return el;
  }

  // Apply viewBox to SVG - this is the smooth, native zoom
  function applyViewBox() {
    mapSvg.setAttribute('viewBox', 
      `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`
    );
  }

  // Fit map to container
  function fitToScreen() {
    const rect = mapContainer.getBoundingClientRect();
    const scaleX = rect.width / viewBox.originalW;
    const scaleY = rect.height / viewBox.originalH;
    const scale = Math.min(scaleX, scaleY);
    
    viewBox.width = rect.width / scale;
    viewBox.height = rect.height / scale;
    viewBox.x = (viewBox.originalW - viewBox.width) / 2;
    viewBox.y = (viewBox.originalH - viewBox.height) / 2;
    
    state.minZoom = Math.min(viewBox.originalW / viewBox.width, viewBox.originalH / viewBox.height);
    
    applyViewBox();
  }

  // Zoom centered on a point
  function zoomAt(factor, centerX, centerY) {
    const svgPoint = screenToSvg(centerX, centerY);
    
    const newWidth = viewBox.width * factor;
    const newHeight = viewBox.height * factor;
    
    // Calculate zoom scale and clamp
    const currentZoom = viewBox.originalW / viewBox.width;
    const newZoom = viewBox.originalW / newWidth;
    const clampedZoom = clamp(newZoom, state.minZoom, state.maxZoom);
    
    const actualNewWidth = viewBox.originalW / clampedZoom;
    const actualNewHeight = viewBox.originalH / clampedZoom;
    
    // Keep the point under cursor stationary
    const relX = (svgPoint.x - viewBox.x) / viewBox.width;
    const relY = (svgPoint.y - viewBox.y) / viewBox.height;
    
    viewBox.width = actualNewWidth;
    viewBox.height = actualNewHeight;
    viewBox.x = svgPoint.x - relX * viewBox.width;
    viewBox.y = svgPoint.y - relY * viewBox.height;
    
    // Clamp to bounds (center if zoomed out)
    if (viewBox.width > viewBox.originalW) {
      viewBox.x = (viewBox.originalW - viewBox.width) / 2;
    } else {
      viewBox.x = clamp(viewBox.x, 0, viewBox.originalW - viewBox.width);
    }
    
    if (viewBox.height > viewBox.originalH) {
      viewBox.y = (viewBox.originalH - viewBox.height) / 2;
    } else {
      viewBox.y = clamp(viewBox.y, 0, viewBox.originalH - viewBox.height);
    }
    
    applyViewBox();
  }

  // Pan the view
  function pan(dx, dy) {
    const rect = mapContainer.getBoundingClientRect();
    
    // Calculate scale as in screenToSvg
    const scaleX = rect.width / viewBox.width;
    const scaleY = rect.height / viewBox.height;
    const scale = Math.min(scaleX, scaleY);
    
    const svgDx = dx / scale;
    const svgDy = dy / scale;
    
    viewBox.x -= svgDx;
    viewBox.y -= svgDy;
    
    // Clamp to bounds (center if zoomed out)
    if (viewBox.width > viewBox.originalW) {
      viewBox.x = (viewBox.originalW - viewBox.width) / 2;
    } else {
      viewBox.x = clamp(viewBox.x, 0, viewBox.originalW - viewBox.width);
    }
    
    if (viewBox.height > viewBox.originalH) {
      viewBox.y = (viewBox.originalH - viewBox.height) / 2;
    } else {
      viewBox.y = clamp(viewBox.y, 0, viewBox.originalH - viewBox.height);
    }
    
    applyViewBox();
  }

  // Highlight waypoint without jumping (but fit to show whole map)
  function jumpTo(wp) {
    state.selectedId = wp.id;
    fitToScreen(); // Auto-fit to show entire map
    render();
    showInfoPanel(wp);
  }
  
  // Show info panel for a waypoint
  function showInfoPanel(wp) {
    infoPanelTitle.textContent = wp.name || 'Location';
    infoPanelGroup.textContent = wp.group || '';
    
    if (wp.image) {
      infoPanelImage.src = wp.image;
      infoPanelImage.classList.add('hasImage');
    } else {
      infoPanelImage.classList.remove('hasImage');
    }
    
    if (wp.description) {
      infoPanelDescription.textContent = wp.description;
      infoPanelDescription.style.display = 'block';
    } else {
      infoPanelDescription.innerHTML = '<div class="infoPanelEmpty">No description available</div>';
    }
    
    infoPanel.classList.add('show');
  }
  
  // Hide info panel
  function hideInfoPanel() {
    infoPanel.classList.remove('show');
  }

  // Render markers as SVG elements
  function render() {
    markerLayer.innerHTML = "";
    
    APP_DATA.waypoints.forEach(wp => {
      const isActive = (wp.id === state.selectedId);
      const isStart = (wp.type === 'start');
      
      // Skip rendering if not active, not start, and showAllMarkers is false
      if (!isActive && !isStart && !CONFIG.showAllMarkers) {
        return;
      }
      
      const svgX = wp.xRel * viewBox.originalW;
      const svgY = wp.yRel * viewBox.originalH;
      
      const markerGroup = createSVGElement('g', {
        'data-marker-id': wp.id,
        'class': 'marker-group'
      });
      
      if (isActive) {
        // Active marker - pulsing glow effect
        const glowRing = createSVGElement('circle', {
          'cx': svgX,
          'cy': svgY,
          'r': '20',
          'fill': 'rgba(0, 122, 255, 0.2)',
          'class': 'pulse-ring'
        });
        markerGroup.appendChild(glowRing);
        
        // Main circle
        const circle = createSVGElement('circle', {
          'cx': svgX,
          'cy': svgY,
          'r': '10',
          'fill': '#007aff',
          'stroke': '#fff',
          'stroke-width': '3',
          'class': 'marker-circle',
          'filter': 'drop-shadow(0 2px 6px rgba(0,0,0,0.3))'
        });
        markerGroup.appendChild(circle);
        
        // Inner white dot
        const innerDot = createSVGElement('circle', {
          'cx': svgX,
          'cy': svgY,
          'r': '4',
          'fill': '#fff'
        });
        markerGroup.appendChild(innerDot);
        
        // Label
        addLabel(markerGroup, svgX, svgY - 24, wp.name, '#007aff');
      } else if (isStart) {
        // Start marker - pulsing red circle
        const pulseRing = createSVGElement('circle', {
          'cx': svgX,
          'cy': svgY,
          'r': '15',
          'fill': 'none',
          'stroke': '#ff3b30',
          'stroke-width': '2',
          'class': 'pulse-ring'
        });
        markerGroup.appendChild(pulseRing);
        
        const circle = createSVGElement('circle', {
          'cx': svgX,
          'cy': svgY,
          'r': '8',
          'fill': '#ff3b30',
          'stroke': '#fff',
          'stroke-width': '2',
          'class': 'marker-circle'
        });
        markerGroup.appendChild(circle);
        
        // Label
        addLabel(markerGroup, svgX, svgY - 18, "You Are Here", '#ff3b30');
      } else {
        // Regular marker - yellow circle
        const circle = createSVGElement('circle', {
          'cx': svgX,
          'cy': svgY,
          'r': '8',
          'fill': '#ffb700',
          'stroke': '#fff',
          'stroke-width': '2',
          'class': 'marker-circle'
        });
        markerGroup.appendChild(circle);
        
        // Label (hidden by default, shown on hover)
        addLabel(markerGroup, svgX, svgY - 18, wp.name, '#1a1a1a', true);
      }
      
      // Click handler
      markerGroup.style.cursor = 'pointer';
      markerGroup.addEventListener('click', (e) => {
        e.stopPropagation();
        jumpTo(wp);
      });
      
      markerLayer.appendChild(markerGroup);
    });
    
    rebuildDropdown();
  }
  
  // Add label to marker
  function addLabel(parent, x, y, text, bgColor, hideByDefault = false) {
    const labelGroup = createSVGElement('g', {
      'class': 'marker-label-group',
      'opacity': hideByDefault ? '0' : '1'
    });
    
    // Measure text (approximate)
    const textWidth = text.length * 7 + 24;
    const textHeight = 24;
    
    // Background
    const bg = createSVGElement('rect', {
      'x': x - textWidth / 2,
      'y': y - textHeight / 2,
      'width': textWidth,
      'height': textHeight,
      'class': 'marker-label-bg',
      'fill': bgColor
    });
    labelGroup.appendChild(bg);
    
    // Text
    const label = createSVGElement('text', {
      'x': x,
      'y': y + 5,
      'text-anchor': 'middle',
      'class': 'marker-label'
    });
    label.textContent = text;
    labelGroup.appendChild(label);
    
    // Hover effect for hidden labels
    if (hideByDefault) {
      parent.addEventListener('mouseenter', () => {
        labelGroup.setAttribute('opacity', '1');
      });
      parent.addEventListener('mouseleave', () => {
        labelGroup.setAttribute('opacity', '0');
      });
    }
    
    parent.appendChild(labelGroup);
  }

  // Dropdown & List Logic
  function rebuildDropdown(){
    const q = searchInput.value.trim().toLowerCase();
    dropdown.innerHTML = "";
    if(!q){ dropdown.classList.remove("show"); return; }
    const matches = APP_DATA.waypoints.filter(w => w.name.toLowerCase().includes(q));
    if(matches.length === 0) {
        dropdown.innerHTML = `<div class="dropItem" style="cursor:default;color:var(--muted);text-align:center">No results found</div>`;
        dropdown.classList.add("show"); return;
    }
    matches.slice(0,10).forEach(wp => {
       const div = document.createElement("div"); div.className="dropItem";
       div.innerHTML = `<div><b>${wp.name}</b>${wp.group?` <span style="font-size:12px;color:#888">[${wp.group}]</span>`:""}</div>`;
       div.onclick = () => { searchInput.value=""; dropdown.classList.remove("show"); jumpTo(wp); };
       dropdown.appendChild(div);
    });
    dropdown.classList.add("show");
  }

  function rebuildList(){
    listBox.innerHTML = "";
    let list = [...APP_DATA.waypoints].sort((a,b) => a.name.localeCompare(b.name));
    if(!list.length) listBox.innerHTML = "<div style='color:#888;text-align:center'>No waypoints loaded.</div>";
    list.forEach(wp => {
       const div = document.createElement("div"); div.className="listItem";
       div.innerHTML = `<div>${wp.group?`<span class="tag">${wp.group}</span>`:""}<b>${wp.name}</b></div><span style="color:var(--accent);font-size:12px">Go</span>`;
       div.onclick = () => { listModal.classList.remove("show"); jumpTo(wp); };
       listBox.appendChild(div);
    });
  }

  // Events
  el("homeBtn").onclick = () => { 
    fitToScreen(); 
    // Keep selection and info panel open if something is selected
    if (state.selectedId) {
      render(); // Re-render to show the marker at new zoom level
    } else {
      hideInfoPanel();
    }
  };
  el("listBtn").onclick = () => { rebuildList(); listModal.classList.add("show"); };
  el("closeList").onclick = () => listModal.classList.remove("show");
  el("infoPanelClose").onclick = () => {
    hideInfoPanel();
    state.selectedId = null;
    render();
  };
  searchInput.oninput = rebuildDropdown;

  // Pointer events for pan
  mapContainer.onpointerdown = e => {
    mapContainer.setPointerCapture(e.pointerId);
    state.pointers.set(e.pointerId, {x: e.clientX, y: e.clientY});
    
    if (state.pointers.size === 1) {
      state.isPanning = true;
      state.panStart = {
        x: e.clientX,
        y: e.clientY,
        vbX: viewBox.x,
        vbY: viewBox.y
      };
      mapContainer.classList.add('panning');
    } else if (state.pointers.size === 2) {
      state.isPanning = false;
      const pts = [...state.pointers.values()];
      state.lastPinchDist = Math.hypot(pts[0].x - pts[1].x, pts[0].y - pts[1].y);
      state.lastPinchCenter = { x: (pts[0].x + pts[1].x) / 2, y: (pts[0].y + pts[1].y) / 2 };
    }
  };

  mapContainer.onpointermove = e => {
    if (!state.pointers.has(e.pointerId)) return;
    state.pointers.set(e.pointerId, {x: e.clientX, y: e.clientY});

    if (state.pointers.size === 2) {
      // Pinch zoom
      const pts = [...state.pointers.values()];
      const dist = Math.hypot(pts[0].x - pts[1].x, pts[0].y - pts[1].y);
      const center = { x: (pts[0].x + pts[1].x) / 2, y: (pts[0].y + pts[1].y) / 2 };
      
      if (state.lastPinchDist) {
        const factor = state.lastPinchDist / dist;
        zoomAt(factor, center.x, center.y);
      }
      
      state.lastPinchDist = dist;
      state.lastPinchCenter = center;
    } else if (state.isPanning) {
      // Pan
      const dx = e.clientX - state.panStart.x;
      const dy = e.clientY - state.panStart.y;
      const rect = mapContainer.getBoundingClientRect();
      const svgDx = dx * (viewBox.width / rect.width);
      const svgDy = dy * (viewBox.height / rect.height);
      
      viewBox.x = clamp(state.panStart.vbX - svgDx, 0, viewBox.originalW - viewBox.width);
      viewBox.y = clamp(state.panStart.vbY - svgDy, 0, viewBox.originalH - viewBox.height);
      
      applyViewBox();
    }
  };

  mapContainer.onpointerup = mapContainer.onpointercancel = e => {
    state.pointers.delete(e.pointerId);
    state.lastPinchDist = null;
    
    // Don't deselect on click - selection persists
    // Only updates when user selects a new location via search/directory
    // or closes the info panel
    
    if (state.pointers.size === 1) {
      const p = [...state.pointers.values()][0];
      state.isPanning = true;
      state.panStart = {
        x: p.x,
        y: p.y,
        vbX: viewBox.x,
        vbY: viewBox.y
      };
    } else {
      state.isPanning = false;
      mapContainer.classList.remove('panning');
    }
  };

  // Wheel zoom
  mapContainer.onwheel = e => {
    e.preventDefault();
    const factor = e.deltaY < 0 ? 0.9 : 1.1;
    zoomAt(factor, e.clientX, e.clientY);
  };

  // Prevent browser zoom on desktop
  document.addEventListener('wheel', (e) => {
    if (e.ctrlKey || e.metaKey) {
      e.preventDefault();
    }
  }, { passive: false });

  // Prevent iOS Safari gesture zoom
  document.addEventListener('gesturestart', (e) => {
    e.preventDefault();
  }, { passive: false });
  
  document.addEventListener('gesturechange', (e) => {
    e.preventDefault();
  }, { passive: false });
  
  document.addEventListener('gestureend', (e) => {
    e.preventDefault();
  }, { passive: false });

  // Initialize - SVG is already embedded
  function loadSvg() {
    // ViewBox already set from the embedded SVG
    const vb = mapSvg.getAttribute('viewBox').split(' ').map(Number);
    viewBox.x = vb[0];
    viewBox.y = vb[1];
    viewBox.width = vb[2];
    viewBox.height = vb[3];
    viewBox.originalW = vb[2];
    viewBox.originalH = vb[3];
    
    // Initialize the map
    init();
  }

  // Init
  function init() {
    fitToScreen();
    render();
  }

  // Debounced resize with orientation change support
  let resizeTimeout;
  function handleResize() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      fitToScreen();
    }, 150);
  }
  
  window.addEventListener('resize', handleResize);
  window.addEventListener('orientationchange', () => {
    setTimeout(() => {
      fitToScreen();
    }, 300);
  });

  // Start
  loadSvg();
})();
</script>
</body>
</html>

